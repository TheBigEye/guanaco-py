name: Build Wheels (CUDA)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pyver: "3.9"
            cuda: "12.1.1"
            short: cu121
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.1.1"
            short: cu121
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.1.1"
            short: cu121
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.1.1"
            short: cu121
            arch: 75;80;86;89;90
          - pyver: "3.9"
            cuda: "12.2.2"
            short: cu122
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.2.2"
            short: cu122
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.2.2"
            short: cu122
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.2.2"
            short: cu122
            arch: 75;80;86;89;90
          - pyver: "3.9"
            cuda: "12.3.2"
            short: cu123
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.3.2"
            short: cu123
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.3.2"
            short: cu123
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.3.2"
            short: cu123
            arch: 75;80;86;89;90
          - pyver: "3.9"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
    name: Linux CUDA ${{ matrix.cuda }} Py ${{ matrix.pyver }}
    env:
      CUDAVER: ${{ matrix.cuda }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.pyver }}
          enable-cache: true

      - name: Setup Miniconda and Mamba
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: llamacpp
          python-version: ${{ matrix.pyver }}
          miniforge-version: latest
          auto-activate-base: false

      - name: Install CUDA toolkit via Mamba
        shell: bash -l {0}
        run: |
          mamba install -y -c nvidia/label/cuda-${{ matrix.cuda }} cuda

      - name: Install build tools
        shell: bash -l {0}
        run: |
          uv pip install build wheel cmake setuptools packaging
          uv pip install --upgrade cmake

      - name: Build wheel
        shell: bash -l {0}
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
          CUDA_PATH: ${{ steps.conda.outputs.conda-prefix }}
          CUDA_HOME: ${{ steps.conda.outputs.conda-prefix }}
          CUDA_TOOLKIT_ROOT_DIR: ${{ steps.conda.outputs.conda-prefix }}
          LD_LIBRARY_PATH: ${{ steps.conda.outputs.conda-prefix }}/lib:${{ env.LD_LIBRARY_PATH }}
        run: |
          python -m build --wheel

      - name: List wheels
        run: ls -lh dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.short }}
          path: dist/*.whl

  build_windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - pyver: "3.9"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.10"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.11"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          - pyver: "3.12"
            cuda: "12.4.1"
            short: cu124
            arch: 75;80;86;89;90
          # Agregá más versiones nuevas aquí (12.6, 12.8) fácilmente
    name: Windows CUDA ${{ matrix.cuda }} Py ${{ matrix.pyver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CUDA toolkit
        uses: N-Storm/cuda-toolkit@v0.2.29
        with:
          cuda: ${{ matrix.cuda }}
          use-github-cache: true

      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.pyver }}
          enable-cache: true

      - name: Enable long paths
        run: git config --system core.longpaths true

      - name: Install build tools
        run: uv pip install build wheel cmake setuptools packaging

      - name: Build wheel
        env:
          VERBOSE: 1
          CMAKE_ARGS: >-
            -DGGML_CUDA=on
            -DCMAKE_CUDA_ARCHITECTURES=${{ matrix.arch }}
            -DGGML_CUDA_FORCE_MMQ=OFF
            -DGGML_AVX=off -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off
        run: python -m build --wheel

      - name: List wheels
        run: Get-ChildItem dist/*.whl

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-cuda-${{ matrix.pyver }}-${{ matrix.short }}-win
          path: dist/*.whl
