# Hardened version of .github/workflows/test.yaml
# Changes included:
#  - enforce working-directory to avoid accidental deletions of D:\a
#  - early sanity checks for workspace path (very useful to catch issues on Windows)
#  - cross-platform safe remove helper for any cleanup steps (only removes inside ${GITHUB_WORKSPACE})
#  - use PowerShell on Windows when using Windows-only commands
#  - pin cache/restore steps remain but ensure path keys are explicit

name: Tests
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, dev ]

env:
  REPO_ID: Qwen/Qwen2-0.5B-Instruct-GGUF
  MODEL_FILE: qwen2-0_5b-instruct-q8_0.gguf

jobs:
  download-model:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python: [3.11, 3.12]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanity check workspace (cross-platform)
        shell: bash
        run: |
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          # On Windows hosted runner, workspace should be under D:\a
          if [ "${RUNNER_OS}" = "Windows" ]; then
            powershell -Command "if (-not (Test-Path env:GITHUB_WORKSPACE)) { Write-Error 'GITHUB_WORKSPACE missing (pwsh)'; exit 1 }"
            powershell -Command "Write-Host 'Listing root D:\\'; Get-ChildItem -Path D:\\ -Force | Select-Object -First 20"
          else
            echo "Listing root / (first 20):"; ls / | head -n 20 || true
          fi

      - name: Fail if workspace root missing (explicit check)
        shell: bash
        run: |
          if [ -z "${GITHUB_WORKSPACE}" ]; then echo "GITHUB_WORKSPACE is empty"; exit 1; fi
          if [ "${RUNNER_OS}" = "Windows" ]; then
            # powershell check ensures the path exists
            powershell -NoProfile -Command "if (-not (Test-Path \"${env:GITHUB_WORKSPACE}\")) { Write-Error 'Workspace path does not exist'; exit 1 }"
          else
            test -d "${GITHUB_WORKSPACE}" || (echo "Workspace ${GITHUB_WORKSPACE} missing" && exit 1)
          fi

      - name: Setup safe-clean helper (for later cleanup steps)
        shell: bash
        run: |
          # this helper only removes paths under GITHUB_WORKSPACE
          cat > .github/actions/safe-clean.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          TARGET="$1"
          WORKSPACE="${GITHUB_WORKSPACE}"
          case "${TARGET}" in
            "" ) echo "No target provided"; exit 1;;
          esac
          # canonicalize paths
          canon_target=$(python - <<PY
          import os,sys
          print(os.path.realpath(sys.argv[1]))
          PY
          "$TARGET")
          canon_ws=$(python - <<PY
          import os,sys
          print(os.path.realpath(sys.argv[1]))
          PY
          "$WORKSPACE")
          if [[ "$canon_target" != "$canon_ws"* ]]; then
            echo "Refusing to delete outside of workspace: $canon_target"; exit 1
          fi
          echo "Deleting $canon_target"; rm -rf "$canon_target"
          EOF
          chmod +x .github/actions/safe-clean.sh

      - name: Restore model cache
        uses: actions/cache@v5
        with:
          path: ~/.cache/huggingface/hub
          key: ${{ runner.os }}-model-${{ env.REPO_ID }}-${{ env.MODEL_FILE }}

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade wheel
          # Make sure to run correct pip install -e .[all]
          python -m pip install -e .[all] --verbose

      - name: Install dependencies (Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[all] --verbose

      - name: Test with pytest
        run: |
          python -m pytest
